[
    {
        "id": "google_auth_flow",
        "type": "tab",
        "label": "Google Auth Flow",
        "disabled": false,
        "info": ""
    },
    {
        "id": "http_in",
        "type": "http in",
        "z": "google_auth_flow",
        "name": "POST /api/auth/google",
        "url": "/api/auth/google",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 150,
        "y": 120,
        "wires": [
            [
                "google_api_prep"
            ]
        ]
    },
    {
        "id": "google_api_prep",
        "type": "function",
        "z": "google_auth_flow",
        "name": "æº–å‚™ Google API è«‹æ±‚",
        "func": "/**\n * ç¯€é» Aï¼šæº–å‚™å‘¼å« Google API (ç¬¬ 2 å€‹ç¯€é»)\n */\n\n// å–å¾—å‰ç«¯ POST éä¾†çš„ token\nlet googleToken = msg.payload.token;\n\nif (!googleToken) {\n    msg.payload = { error: \"ç¼ºå°‘ Google Token\" };\n    msg.statusCode = 400;\n    return [null, msg]; // çµæŸæµç¨‹ä¸¦è·³åˆ°éŒ¯èª¤å›æ‡‰\n}\n\n// è¨­å®š HTTP Request ç¯€é»è¦å‘¼å«çš„ç›®æ¨™ç¶²å€\nmsg.url = \"https://oauth2.googleapis.com/tokeninfo?id_token=\" + googleToken;\nmsg.method = \"GET\";\n\nreturn [msg, null];",
        "outputs": 2,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 380,
        "y": 120,
        "wires": [
            [
                "google_request"
            ],
            [
                "http_response"
            ]
        ]
    },
    {
        "id": "google_request",
        "type": "http request",
        "z": "google_auth_flow",
        "name": "Google Tokeninfo",
        "method": "GET",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "",
        "persist": false,
        "proxy": "",
        "authType": "",
        "x": 610,
        "y": 120,
        "wires": [
            [
                "mysql_prep"
            ]
        ]
    },
    {
        "id": "mysql_prep",
        "type": "function",
        "z": "google_auth_flow",
        "name": "è§£æçµæœä¸¦æº–å‚™ MySQL",
        "func": "/**\n * ç¯€é» Bï¼šè§£æ Google å›æ‡‰ä¸¦æŸ¥è©¢ MySQL (ç¬¬ 4 å€‹ç¯€é»)\n */\n\n// è§£æ Google å›å‚³çš„ JSON è³‡æ–™\nlet googleData = typeof msg.payload === 'string' ? JSON.parse(msg.payload) : msg.payload;\n\n// æª¢æŸ¥ Google æ˜¯å¦å›å‚³éŒ¯èª¤\nif (googleData.error) {\n    msg.payload = { error: \"Google é©—è­‰å¤±æ•—\", details: googleData.error_description };\n    msg.statusCode = 401;\n    return [null, msg]; \n}\n\n// æå–å‡ºå®‰å…¨ä¸”ç¶“éé©—è­‰çš„ Email å’Œ å§“å\nlet userEmail = googleData.email;\nlet firstName = googleData.given_name || '';\nlet lastName = googleData.family_name || '';\n\n// å°‡åŸºæœ¬è³‡æ–™æš«å­˜èµ·ä¾†ï¼Œå¾Œé¢æœƒç”¨åˆ°\nmsg.userData = {\n    email: userEmail,\n    first_name: firstName,\n    last_name: lastName\n};\n\n// çµ„è£ MySQL æŸ¥è©¢æŒ‡ä»¤ï¼šæª¢æŸ¥æ­¤ Email æ˜¯å¦å­˜åœ¨æˆ‘å€‘çš„ Users è¡¨ä¸­\nmsg.topic = \"SELECT * FROM Users WHERE email = ? LIMIT 1\";\nmsg.payload = [userEmail];\n\nreturn [msg, null];",
        "outputs": 2,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 190,
        "y": 240,
        "wires": [
            [
                "mysql_node"
            ],
            [
                "http_response"
            ]
        ]
    },
    {
        "id": "mysql_node",
        "type": "mysql",
        "z": "google_auth_flow",
        "mydb": "",
        "name": "MySQL Users",
        "x": 420,
        "y": 240,
        "wires": [
            [
                "auth_logic"
            ]
        ]
    },
    {
        "id": "auth_logic",
        "type": "function",
        "z": "google_auth_flow",
        "name": "ç™»å…¥é‚è¼¯åˆ¤æ–·",
        "func": "/**\n * ç¯€é» Cï¼šåˆ¤æ–·ç™»å…¥ç‹€æ…‹èˆ‡æ ¸ç™¼ Token (ç¬¬ 6 å€‹ç¯€é»)\n */\n\nlet dbResult = msg.payload; // é€™æ˜¯ MySQL ç¯€é»å›å‚³çš„é™£åˆ—çµæœ\n\nif (dbResult.length > 0) {\n    // ğŸŸ¢ æƒ…å¢ƒä¸€ï¼šèˆŠæœ‹å‹ (è³‡æ–™åº«æœ‰ç´€éŒ„)\n    let user = dbResult[0];\n    \n    // æª¢æŸ¥ä»–æ˜¯å¦å·²ç¶“å¡«éå–®ä½å’Œè·ç¨±\n    if (user.department_id === null || user.job_title_id === null) {\n        // ğŸŸ¡ æœ‰ Email ä½†æ²’å¡«å¦¥è·ç¨± (å¯èƒ½ä¸Šæ¬¡è¨»å†Šä¸­æ–·)\n        msg.payload = { \n            message: \"è«‹è£œé½Šå–®ä½èˆ‡è·ç¨±è³‡æ–™\", \n            action: \"REQUIRE_INFO\",\n            email: msg.userData.email\n        };\n        msg.statusCode = 206; // 206 Partial Content\n    } else {\n        // ğŸŸ¢ è³‡æ–™å®Œæ•´ï¼Œç›´æ¥ç™¼æ”¾ç³»çµ±å°ˆå±¬ Token è®“ä»–ç™»å…¥\n        let sessionToken = \"sys_token_\" + new Date().getTime() + \"_\" + user.id; \n        \n        msg.payload = { \n            message: \"ç™»å…¥æˆåŠŸ\", \n            action: \"LOGIN_SUCCESS\",\n            token: sessionToken,\n            user: {\n                id: user.id,\n                name: user.last_name + user.first_name\n            }\n        };\n        msg.statusCode = 200;\n    }\n} else {\n    // ğŸ”µ æƒ…å¢ƒäºŒï¼šæ–°æœ‹å‹ (è³‡æ–™åº«æ²’ç´€éŒ„)\n    msg.payload = { \n        message: \"æ­¡è¿é¦–æ¬¡ç™»å…¥ï¼Œè«‹å¡«å¯«æ‚¨çš„å–®ä½èˆ‡è·ç¨±\", \n        action: \"REQUIRE_INFO\",\n        email: msg.userData.email,\n        first_name: msg.userData.first_name,\n        last_name: msg.userData.last_name\n    };\n    msg.statusCode = 206;\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 630,
        "y": 240,
        "wires": [
            [
                "http_response"
            ]
        ]
    },
    {
        "id": "http_response",
        "type": "http response",
        "z": "google_auth_flow",
        "name": "HTTP Response",
        "statusCode": "",
        "headers": {},
        "x": 840,
        "y": 180,
        "wires": []
    },
    {
        "id": "http_in_register",
        "type": "http in",
        "z": "google_auth_flow",
        "name": "POST /api/auth/register",
        "url": "/api/auth/register",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 160,
        "y": 360,
        "wires": [
            [
                "prep_register_sql"
            ]
        ]
    },
    {
        "id": "prep_register_sql",
        "type": "function",
        "z": "google_auth_flow",
        "name": "æº–å‚™ INSERT MySQL",
        "func": "let data = msg.payload;\n\nif (!data.email || !data.first_name || !data.last_name || !data.department_id || !data.job_title_id) {\n    msg.payload = { error: 'è¨»å†Šè³‡æ–™ä¸å®Œæ•´' };\n    msg.statusCode = 400;\n    return [null, msg];\n}\n\nmsg.userData = data;\n\nmsg.topic = 'INSERT INTO Users (email, first_name, last_name, department_id, job_title_id) VALUES (?, ?, ?, ?, ?)';\n\nmsg.payload = [\n    data.email, \n    data.first_name, \n    data.last_name, \n    data.department_id, \n    data.job_title_id\n];\n\nreturn [msg, null];",
        "outputs": 2,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 410,
        "y": 360,
        "wires": [
            [
                "mysql_register_node"
            ],
            [
                "http_response_register"
            ]
        ]
    },
    {
        "id": "mysql_register_node",
        "type": "mysql",
        "z": "google_auth_flow",
        "mydb": "dummy-mysql-config",
        "name": "MySQL Insert User",
        "x": 630,
        "y": 360,
        "wires": [
            [
                "register_success_logic"
            ]
        ]
    },
    {
        "id": "register_success_logic",
        "type": "function",
        "z": "google_auth_flow",
        "name": "è¨»å†ŠæˆåŠŸæ ¸ç™¼ Token",
        "func": "let sessionToken = 'sys_token_' + new Date().getTime() + '_' + Buffer.from(msg.userData.email).toString('base64');\n\nmsg.payload = {\n    message: 'è¨»å†Šä¸¦ç™»å…¥æˆåŠŸ',\n    action: 'LOGIN_SUCCESS',\n    token: sessionToken,\n    user: {\n        name: msg.userData.last_name + msg.userData.first_name,\n        email: msg.userData.email\n    }\n};\nmsg.statusCode = 200;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 850,
        "y": 360,
        "wires": [
            [
                "http_response_register"
            ]
        ]
    },
    {
        "id": "http_response_register",
        "type": "http response",
        "z": "google_auth_flow",
        "name": "HTTP Response",
        "statusCode": "",
        "headers": {},
        "x": 1080,
        "y": 400,
        "wires": []
    }
]