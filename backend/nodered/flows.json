[
    {
        "id": "cba2dbb329ebd66f",
        "type": "tab",
        "label": "Google Auth Flow",
        "disabled": false,
        "info": ""
    },
    {
        "id": "c248818590732ae2",
        "type": "http in",
        "z": "cba2dbb329ebd66f",
        "name": "POST /api/auth/google",
        "url": "/api/auth/google",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 150,
        "y": 120,
        "wires": [
            [
                "888d0d88b2507872"
            ]
        ]
    },
    {
        "id": "888d0d88b2507872",
        "type": "function",
        "z": "cba2dbb329ebd66f",
        "name": "æº–å‚™ Google API è«‹æ±‚",
        "func": "/**\n * ç¯€é» Aï¼šæº–å‚™å‘¼å« Google API (ç¬¬ 2 å€‹ç¯€é»)\n */\n\n// å–å¾—å‰ç«¯ POST éä¾†çš„ token\nlet googleToken = msg.payload.token;\n\nif (!googleToken) {\n    msg.payload = { error: \"ç¼ºå°‘ Google Token\" };\n    msg.statusCode = 400;\n    return [null, msg]; // çµæŸæµç¨‹ä¸¦è·³åˆ°éŒ¯èª¤å›æ‡‰\n}\n\n// è¨­å®š HTTP Request ç¯€é»è¦å‘¼å«çš„ç›®æ¨™ç¶²å€\nmsg.url = \"https://oauth2.googleapis.com/tokeninfo?id_token=\" + googleToken;\nmsg.method = \"GET\";\n\nreturn [msg, null];",
        "outputs": 2,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 380,
        "y": 120,
        "wires": [
            [
                "952797bc53388c6b"
            ],
            [
                "c653fc824e52015a"
            ]
        ]
    },
    {
        "id": "952797bc53388c6b",
        "type": "http request",
        "z": "cba2dbb329ebd66f",
        "name": "Google Tokeninfo",
        "method": "use",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "",
        "persist": false,
        "proxy": "",
        "authType": "",
        "x": 610,
        "y": 120,
        "wires": [
            [
                "583fa83f025d1893"
            ]
        ]
    },
    {
        "id": "583fa83f025d1893",
        "type": "function",
        "z": "cba2dbb329ebd66f",
        "name": "è§£æçµæœä¸¦æº–å‚™ MySQL",
        "func": "/**\n * ç¯€é» Bï¼šè§£æ Google å›æ‡‰ä¸¦æŸ¥è©¢ MySQL (ç¬¬ 4 å€‹ç¯€é»)\n */\n\n// è§£æ Google å›å‚³çš„ JSON è³‡æ–™\nlet googleData = typeof msg.payload === 'string' ? JSON.parse(msg.payload) : msg.payload;\n\n// æª¢æŸ¥ Google æ˜¯å¦å›å‚³éŒ¯èª¤\nif (googleData.error) {\n    msg.payload = { error: \"Google é©—è­‰å¤±æ•—\", details: googleData.error_description };\n    msg.statusCode = 401;\n    return [null, msg]; \n}\n\n// æå–å‡ºå®‰å…¨ä¸”ç¶“éé©—è­‰çš„ Email å’Œ å§“å\nlet userEmail = googleData.email;\nlet firstName = googleData.given_name || '';\nlet lastName = googleData.family_name || '';\n\n// å°‡åŸºæœ¬è³‡æ–™æš«å­˜èµ·ä¾†ï¼Œå¾Œé¢æœƒç”¨åˆ°\nmsg.userData = {\n    email: userEmail,\n    first_name: firstName,\n    last_name: lastName\n};\n\n// çµ„è£ MySQL æŸ¥è©¢æŒ‡ä»¤ï¼šæª¢æŸ¥æ­¤ Email æ˜¯å¦å­˜åœ¨æˆ‘å€‘çš„ Users è¡¨ä¸­\nmsg.topic = \"SELECT * FROM Users WHERE email = ? LIMIT 1\";\nmsg.payload = [userEmail];\n\nreturn [msg, null];",
        "outputs": 2,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 190,
        "y": 240,
        "wires": [
            [
                "b0af393d96756355"
            ],
            [
                "c653fc824e52015a"
            ]
        ]
    },
    {
        "id": "b0af393d96756355",
        "type": "mysql",
        "z": "cba2dbb329ebd66f",
        "mydb": "0bdc806336f756dc",
        "name": "MySQL Users",
        "x": 420,
        "y": 240,
        "wires": [
            [
                "b950aed829468a8d"
            ]
        ]
    },
    {
        "id": "b950aed829468a8d",
        "type": "function",
        "z": "cba2dbb329ebd66f",
        "name": "ç™»å…¥é‚è¼¯åˆ¤æ–·",
        "func": "/**\n * ç¯€é» Cï¼šåˆ¤æ–·ç™»å…¥ç‹€æ…‹èˆ‡æ ¸ç™¼ Token (ç¬¬ 6 å€‹ç¯€é»)\n */\n\nlet dbResult = msg.payload; // é€™æ˜¯ MySQL ç¯€é»å›å‚³çš„é™£åˆ—çµæœ\n\nif (dbResult.length > 0) {\n    // ğŸŸ¢ æƒ…å¢ƒä¸€ï¼šèˆŠæœ‹å‹ (è³‡æ–™åº«æœ‰ç´€éŒ„)\n    let user = dbResult[0];\n    \n    // æª¢æŸ¥ä»–æ˜¯å¦å·²ç¶“å¡«éå–®ä½å’Œè·ç¨±\n    if (user.department_id === null || user.job_title_id === null) {\n        // ğŸŸ¡ æœ‰ Email ä½†æ²’å¡«å¦¥è·ç¨± (å¯èƒ½ä¸Šæ¬¡è¨»å†Šä¸­æ–·)\n        msg.payload = { \n            message: \"è«‹è£œé½Šå–®ä½èˆ‡è·ç¨±è³‡æ–™\", \n            action: \"REQUIRE_INFO\",\n            email: msg.userData.email\n        };\n        msg.statusCode = 206; // 206 Partial Content\n    } else {\n        // ğŸŸ¢ è³‡æ–™å®Œæ•´ï¼Œç›´æ¥ç™¼æ”¾ç³»çµ±å°ˆå±¬ Token è®“ä»–ç™»å…¥\n        let sessionToken = \"sys_token_\" + new Date().getTime() + \"_\" + user.id; \n        \n        msg.payload = { \n            message: \"ç™»å…¥æˆåŠŸ\", \n            action: \"LOGIN_SUCCESS\",\n            token: sessionToken,\n            user: {\n                id: user.id,\n                name: user.last_name + user.first_name,\n                email: user.email,\n                // å¼·åˆ¶æŒ‡å®šç›®å‰çš„è² è²¬äºº Email ç‚ºè¶…ç´šç®¡ç†å“¡\n                global_role: (user.email === \"yi.kuei.co@gmail.com\") ? \"super_admin\" : (user.global_role || \"user\")\n            }\n        };\n        msg.statusCode = 200;\n    }\n} else {\n    // ğŸ”µ æƒ…å¢ƒäºŒï¼šæ–°æœ‹å‹ (è³‡æ–™åº«æ²’ç´€éŒ„)\n    msg.payload = { \n        message: \"æ­¡è¿é¦–æ¬¡ç™»å…¥ï¼Œè«‹å¡«å¯«æ‚¨çš„å–®ä½èˆ‡è·ç¨±\", \n        action: \"REQUIRE_INFO\",\n        email: msg.userData.email,\n        first_name: msg.userData.first_name,\n        last_name: msg.userData.last_name\n    };\n    msg.statusCode = 206;\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 630,
        "y": 240,
        "wires": [
            [
                "c653fc824e52015a"
            ]
        ]
    },
    {
        "id": "c653fc824e52015a",
        "type": "http response",
        "z": "cba2dbb329ebd66f",
        "name": "HTTP Response",
        "statusCode": "",
        "headers": {},
        "x": 840,
        "y": 180,
        "wires": []
    },
    {
        "id": "092a45dbc8f2207a",
        "type": "http in",
        "z": "cba2dbb329ebd66f",
        "name": "POST /api/auth/register",
        "url": "/api/auth/register",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 160,
        "y": 360,
        "wires": [
            [
                "153aa2fe168723e3"
            ]
        ]
    },
    {
        "id": "153aa2fe168723e3",
        "type": "function",
        "z": "cba2dbb329ebd66f",
        "name": "æº–å‚™ INSERT MySQL",
        "func": "let data = msg.payload;\n\nif (!data.email || !data.first_name || !data.last_name || !data.department_id || !data.job_title_id) {\n    msg.payload = { error: 'è¨»å†Šè³‡æ–™ä¸å®Œæ•´' };\n    msg.statusCode = 400;\n    return [null, msg];\n}\n\nmsg.userData = data;\n\nmsg.topic = 'INSERT INTO Users (email, first_name, last_name, department_id, job_title_id) VALUES (?, ?, ?, ?, ?)';\n\nmsg.payload = [\n    data.email, \n    data.first_name, \n    data.last_name, \n    data.department_id, \n    data.job_title_id\n];\n\nreturn [msg, null];",
        "outputs": 2,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 410,
        "y": 360,
        "wires": [
            [
                "bb2e056f21140575"
            ],
            [
                "e0792c48c2c36ad7"
            ]
        ]
    },
    {
        "id": "bb2e056f21140575",
        "type": "mysql",
        "z": "cba2dbb329ebd66f",
        "mydb": "0bdc806336f756dc",
        "name": "MySQL Insert User",
        "x": 630,
        "y": 360,
        "wires": [
            [
                "f2868a13f5153fb1"
            ]
        ]
    },
    {
        "id": "f2868a13f5153fb1",
        "type": "function",
        "z": "cba2dbb329ebd66f",
        "name": "è¨»å†ŠæˆåŠŸæ ¸ç™¼ Token",
        "func": "let sessionToken = 'sys_token_' + new Date().getTime() + '_' + Buffer.from(msg.userData.email).toString('base64');\n\nmsg.payload = {\n    message: 'è¨»å†Šä¸¦ç™»å…¥æˆåŠŸ',\n    action: 'LOGIN_SUCCESS',\n    token: sessionToken,\n    user: {\n        name: msg.userData.last_name + msg.userData.first_name,\n        email: msg.userData.email\n    }\n};\nmsg.statusCode = 200;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 850,
        "y": 360,
        "wires": [
            [
                "e0792c48c2c36ad7"
            ]
        ]
    },
    {
        "id": "e0792c48c2c36ad7",
        "type": "http response",
        "z": "cba2dbb329ebd66f",
        "name": "HTTP Response",
        "statusCode": "",
        "headers": {},
        "x": 1080,
        "y": 400,
        "wires": []
    },
    {
        "id": "0bdc806336f756dc",
        "type": "MySQLdatabase",
        "name": "",
        "host": "10.0.0.5",
        "port": "3306",
        "db": "office",
        "tz": "",
        "charset": "UTF8"
    },
    {
        "id": "group_protected_api",
        "type": "group",
        "z": "cba2dbb329ebd66f",
        "name": "ä¿è­·çš„ API è·¯ç”± (éœ€è¦ Token)",
        "style": {
            "stroke": "#009933",
            "fill": "#e6ffe6",
            "label": true
        },
        "nodes": [
            "node_auth_middleware",
            "node_401_unauthorized",
            "node_get_admin_users",
            "node_get_admin_users_response"
        ],
        "x": 100,
        "y": 480,
        "w": 800,
        "h": 200
    },
    {
        "id": "node_auth_middleware",
        "type": "function",
        "z": "cba2dbb329ebd66f",
        "g": "group_protected_api",
        "name": "Token é©—è­‰ (Middleware)",
        "func": "const authHeader = msg.req.headers['authorization'];\n\nif (authHeader && authHeader.startsWith(\"Bearer \")) {\n    const token = authHeader.substring(7);\n    // é€™è£¡é€šå¸¸æœƒè§£æ Token (ä¾‹å¦‚ JWT æˆ–æ˜¯å» DB æ ¸å°)\n    // ç‚ºäº†ç°¡åŒ–ï¼Œåªè¦æœ‰ sys_token_ é–‹é ­å°±å…ˆæ”¾è¡Œ\n    if (token.startsWith('sys_token_')) {\n        msg.userToken = token;\n        return [msg, null];\n    }\n}\n\nmsg.payload = { error: \"Unauthorized\", message: \"å°šæœªç™»å…¥æˆ– Token ç„¡æ•ˆ\" };\nmsg.statusCode = 401;\nreturn [null, msg];",
        "outputs": 2,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 390,
        "y": 560,
        "wires": [
            [
                "node_get_admin_users_response"
            ],
            [
                "node_401_unauthorized"
            ]
        ]
    },
    {
        "id": "node_401_unauthorized",
        "type": "http response",
        "z": "cba2dbb329ebd66f",
        "g": "group_protected_api",
        "name": "401 Unauthorized",
        "statusCode": "401",
        "headers": {},
        "x": 650,
        "y": 620,
        "wires": []
    },
    {
        "id": "node_get_admin_users",
        "type": "http in",
        "z": "cba2dbb329ebd66f",
        "g": "group_protected_api",
        "name": "GET /api/admin/users",
        "url": "/api/admin/users",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 170,
        "y": 560,
        "wires": [
            [
                "node_auth_middleware"
            ]
        ]
    },
    {
        "id": "node_get_admin_users_response",
        "type": "http response",
        "z": "cba2dbb329ebd66f",
        "g": "group_protected_api",
        "name": "Success Response",
        "statusCode": "200",
        "headers": {},
        "x": 650,
        "y": 520,
        "wires": []
    },
    {
        "id": "node_debug_sql_error",
        "type": "debug",
        "z": "cba2dbb329ebd66f",
        "name": "SQL éŒ¯èª¤è¿½è¹¤",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 380,
        "y": 700,
        "wires": []
    },
    {
        "id": "node_catch_mysql",
        "type": "catch",
        "z": "cba2dbb329ebd66f",
        "name": "æ•æ‰ MySQL éŒ¯èª¤",
        "scope": [
            "b0af393d96756355",
            "bb2e056f21140575"
        ],
        "uncaught": false,
        "x": 170,
        "y": 700,
        "wires": [
            [
                "node_debug_sql_error"
            ]
        ]
    }
]