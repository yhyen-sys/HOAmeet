<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HOAmeet | ç³»çµ±æ¬Šé™ç®¡ç† (Super Admin)</title>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Outfit:wght@400;700&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --primary: #6366f1;
            --secondary: #10b981;
            --danger: #ef4444;
            --bg-dark: #0f172a;
            --glass-bg: rgba(255, 255, 255, 0.03);
            --glass-border: rgba(255, 255, 255, 0.08);
            --text-main: #f8fafc;
            --text-dim: #94a3b8;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-dark);
            color: var(--text-main);
            min-height: 100vh;
            padding: 2rem;
            background: radial-gradient(circle at top right, #1e1b4b, #0f172a);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            z-index: 10;
            position: relative;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2.5rem;
        }

        h1 {
            font-family: 'Outfit', sans-serif;
            font-size: 2.2rem;
            background: linear-gradient(to right, #fbbf24, #ef4444);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .admin-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
            background: rgba(251, 191, 36, 0.1);
            border: 1px solid #fbbf24;
            color: #fbbf24;
        }

        .search-bar {
            margin-bottom: 2rem;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 12px 20px;
            width: 100%;
            max-width: 400px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .search-bar input {
            background: transparent;
            border: none;
            color: white;
            width: 100%;
            outline: none;
        }

        .user-table-wrapper {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            text-align: left;
        }

        th {
            padding: 20px;
            background: rgba(255, 255, 255, 0.02);
            color: var(--text-dim);
            font-weight: 600;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        td {
            padding: 20px;
            border-bottom: 1px solid var(--glass-border);
        }

        tr:last-child td {
            border-bottom: none;
        }

        tr:hover {
            background: rgba(255, 255, 255, 0.01);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
        }

        .user-det {
            display: flex;
            flex-direction: column;
        }

        .user-name {
            font-weight: 600;
            font-size: 0.95rem;
        }

        .user-email {
            font-size: 0.8rem;
            color: var(--text-dim);
        }

        .role-selector {
            display: flex;
            gap: 8px;
        }

        .role-btn {
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            border: 1px solid var(--glass-border);
            background: transparent;
            color: var(--text-dim);
            transition: all 0.2s;
        }

        .role-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .role-btn:hover:not(.active) {
            background: rgba(255, 255, 255, 0.05);
            color: white;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 26px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.1);
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: var(--secondary);
        }

        input:checked+.slider:before {
            transform: translateX(24px);
        }

        .btn-back {
            padding: 10px 20px;
            border-radius: 10px;
            border: 1px solid var(--glass-border);
            background: transparent;
            color: var(--text-dim);
            cursor: pointer;
            text-decoration: none;
            font-size: 0.9rem;
        }

        .btn-back:hover {
            color: white;
            background: rgba(255, 255, 255, 0.05);
        }

        /* Blob Background */
        .bg-blob {
            position: fixed;
            width: 600px;
            height: 600px;
            filter: blur(180px);
            border-radius: 50%;
            z-index: -1;
            opacity: 0.1;
        }

        .blob-1 {
            top: -100px;
            right: -100px;
            background: #fbbf24;
        }

        .blob-2 {
            bottom: -100px;
            left: -100px;
            background: #ef4444;
        }
    </style>
</head>

<body>
    <div class="bg-blob blob-1"></div>
    <div class="bg-blob blob-2"></div>

    <div class="container">
        <header>
            <div>
                <h1>âš™ï¸ ç³»çµ±æ¬Šé™ç®¡ç†</h1>
                <p style="color: var(--text-dim); margin-top: 4px;">è¶…ç´šç®¡ç†è€…æ¨¡å¼ï¼šç®¡æ§å…¨åŸŸç™¼èµ·æœƒè­°æ¬Šé™</p>
            </div>
            <div style="display: flex; align-items: center; gap: 1rem;">
                <div class="admin-badge">SUPER ADMIN</div>
                <a href="calendar.html" class="btn-back">è¿”å›ç³»çµ±</a>
            </div>
        </header>

        <div class="search-bar">
            <span>ğŸ”</span>
            <input type="text" placeholder="æœå°‹å§“åã€Email æˆ– å–®ä½...">
        </div>

        <div class="user-table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th>ä½¿ç”¨è€…</th>
                        <th>å–®ä½</th>
                        <th>å…¨åŸŸè§’è‰²</th>
                        <th>æˆæ¬Šç™¼èµ·æœƒè­°</th>
                    </tr>
                </thead>
                <tbody id="user-list">
                    <!-- æ¨¡æ“¬è³‡æ–™ -->
                    <tr>
                        <td>
                            <div class="user-info">
                                <div class="user-avatar" style="background: #ef4444;">è² è²¬</div>
                                <div class="user-det">
                                    <span class="user-name">ç¶²é è¨­è¨ˆè² è²¬äºº</span>
                                    <span class="user-email">admin@yourdomain.gov.tw</span>
                                </div>
                            </div>
                        </td>
                        <td>å¹•åƒšé•·è¾¦å…¬å®¤</td>
                        <td><span style="color: #fbbf24; font-weight: 700;">è¶…ç´šç®¡ç†è€…</span></td>
                        <td>-</td>
                    </tr>
                    <tr>
                        <td>
                            <div class="user-info">
                                <div class="user-avatar" style="background: #10b981;">æ—é›ª</div>
                                <div class="user-det">
                                    <span class="user-name">æ—é›ªæŸ” å°ˆå“¡</span>
                                    <span class="user-email">lin.sr@gov.tw</span>
                                </div>
                            </div>
                        </td>
                        <td>è²¡å‹™éƒ¨</td>
                        <td><span id="role-1" style="color: var(--secondary);">æˆæ¬Šç™¼èµ·äºº</span></td>
                        <td>
                            <label class="toggle-switch">
                                <input type="checkbox" checked onchange="toggleRole(1, this.checked)">
                                <span class="slider"></span>
                            </label>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <div class="user-info">
                                <div class="user-avatar" style="background: #6366f1;">å¼µæ™º</div>
                                <div class="user-det">
                                    <span class="user-name">å¼µæ™ºå‚‘ åŠ©ç†</span>
                                    <span class="user-email">chang.cj@gov.tw</span>
                                </div>
                            </div>
                        </td>
                        <td>å…¬å…±é—œä¿‚å®¤</td>
                        <td><span id="role-2" style="color: var(--text-dim);">ä¸€èˆ¬ä½¿ç”¨è€…</span></td>
                        <td>
                            <label class="toggle-switch">
                                <input type="checkbox" onchange="toggleRole(2, this.checked)">
                                <span class="slider"></span>
                            </label>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <div class="user-info">
                                <div class="user-avatar" style="background: #c084fc;">é™³å¤§</div>
                                <div class="user-det">
                                    <span class="user-name">é™³å¤§æ–‡ çµ„é•·</span>
                                    <span class="user-email">chen.tw@gov.tw</span>
                                </div>
                            </div>
                        </td>
                        <td>å°ˆæ¡ˆå°çµ„</td>
                        <td><span id="role-3" style="color: var(--secondary);">æˆæ¬Šç™¼èµ·äºº</span></td>
                        <td>
                            <label class="toggle-switch">
                                <input type="checkbox" checked onchange="toggleRole(3, this.checked)">
                                <span class="slider"></span>
                            </label>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // 1. åˆå§‹åŒ–è³‡æ–™èˆ‡ç‹€æ…‹
        const API_BASE = "http://localhost:1880/api";
        const systemToken = localStorage.getItem("hoa_token");
        const currentUser = JSON.parse(localStorage.getItem("hoa_user") || "{}");

        // æ¨¡æ“¬å¾å¾Œç«¯å–å¾—çš„æ‰€æœ‰ä½¿ç”¨è€…æ¸…å–® (å¯¦å‹™ä¸Šæ‡‰å‘¼å« GET /api/admin/users)
        let users = [
            { id: 101, name: "è² è²¬äºº", email: "admin@yourdomain.gov.tw", dept: "å¹•åƒšé•·è¾¦å…¬å®¤", role: "super_admin" },
            { id: 102, name: "æ—é›ªæŸ” å°ˆå“¡", email: "lin.sr@gov.tw", dept: "è²¡å‹™éƒ¨", role: "creator" },
            { id: 103, name: "å¼µæ™ºå‚‘ åŠ©ç†", email: "chang.cj@gov.tw", dept: "å…¬å…±é—œä¿‚å®¤", role: "user" },
            { id: 104, name: "é™³å¤§æ–‡ çµ„é•·", email: "chen.tw@gov.tw", dept: "å°ˆæ¡ˆå°çµ„", role: "creator" }
        ];

        function renderTable() {
            const tbody = document.getElementById('user-list');
            tbody.innerHTML = '';

            users.forEach(user => {
                // é˜²å‘†ï¼šå¦‚æœæ˜¯è¶…ç´šç®¡ç†è€…è‡ªå·±ï¼Œæˆ–æ˜¯ Email åŒ¹é…è² è²¬äººï¼Œå‰‡ä¸é¡¯ç¤ºåˆ‡æ›é–‹é—œ
                const isSelf = (user.id === currentUser.id || user.role === 'super_admin');
                const isChecked = user.role === 'creator' || user.role === 'super_admin' ? 'checked' : '';
                const roleText = user.role === 'super_admin' ? 'è¶…ç´šç®¡ç†è€…' : (user.role === 'creator' ? 'æˆæ¬Šç™¼èµ·äºº' : 'ä¸€èˆ¬ä½¿ç”¨è€…');
                const roleColor = user.role === 'super_admin' ? '#fbbf24' : (user.role === 'creator' ? 'var(--secondary)' : 'var(--text-dim)');

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>
                        <div class="user-info">
                            <div class="user-avatar" style="background: ${isSelf ? '#ef4444' : '#6366f1'};">${user.name.substring(0, 2)}</div>
                            <div class="user-det">
                                <span class="user-name">${user.name}</span>
                                <span class="user-email">${user.email}</span>
                            </div>
                        </div>
                    </td>
                    <td>${user.dept}</td>
                    <td><span id="role-text-${user.id}" style="color: ${roleColor}; font-weight: ${user.role === 'super_admin' ? '700' : '400'};">${roleText}</span></td>
                    <td>
                        ${isSelf ? '<span style="color:var(--text-dim); font-size:0.8rem;">(ç³»çµ±é è¨­æ¬Šé™)</span>' : `
                        <label class="toggle-switch">
                            <input type="checkbox" ${isChecked} onchange="toggleRole(${user.id}, this.checked)">
                            <span class="slider"></span>
                        </label>
                        `}
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // 3. ç•¶é»æ“Šé–‹é—œæ™‚ï¼Œè§¸ç™¼æ›´æ–° API (Optimistic UI)
        function toggleRole(userId, isChecked) {
            const newRole = isChecked ? 'creator' : 'user';
            const roleLabel = document.getElementById(`role-text-${userId}`);

            // æš«å­˜åŸæœ¬ç‹€æ…‹ä»¥å‚™å¤±æ•—æ™‚é‚„åŸ
            const oldText = roleLabel.innerText;
            const oldColor = roleLabel.style.color;

            // æ¨‚è§€ UI æ›´æ–°ï¼šç«‹åˆ»åæ˜ åœ¨ç•«é¢ä¸Š
            roleLabel.innerText = isChecked ? "æˆæ¬Šç™¼èµ·äºº" : "ä¸€èˆ¬ä½¿ç”¨è€…";
            roleLabel.style.color = isChecked ? "var(--secondary)" : "var(--text-dim)";

            console.log(`[RBAC] æ­£åœ¨å°‡ä½¿ç”¨è€… ${userId} æ›´æ–°ç‚º ${newRole}...`);

            // å‘¼å« Node-RED API
            fetch(`${API_BASE}/admin/users/role`, {
                method: "PUT",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": "Bearer " + systemToken
                },
                body: JSON.stringify({
                    user_id: userId,
                    new_role: newRole
                })
            })
                .then(res => {
                    if (!res.ok) throw new Error("æ¬Šé™ä¸è¶³æˆ–ç³»çµ±éŒ¯èª¤");
                    return res.json();
                })
                .then(data => {
                    console.log("âœ… æ¬Šé™æ›´æ–°æˆåŠŸ", data);
                    // æ›´æ–°æœ¬æ©Ÿè³‡æ–™å¿«å–
                    const user = users.find(u => u.id === userId);
                    if (user) user.role = newRole;
                })
                .catch(err => {
                    console.error("âŒ æ›´æ–°å¤±æ•—:", err);
                    alert("æ›´æ–°å¤±æ•—ï¼" + err.message);
                    // é‚„åŸ UI ç‹€æ…‹
                    renderTable();
                });
        }

        document.addEventListener("DOMContentLoaded", renderTable);
    </script>
</body>

</html>